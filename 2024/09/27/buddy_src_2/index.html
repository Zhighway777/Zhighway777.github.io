<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Buddy Compiler æºç è§£è¯»(2) | Zeng::blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="A brief introduction to the overall architectyre of buddy Compiler and an analysis some of the buddy. (...)">
    <meta name="generator" content="Hugo 0.92.2" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    
      <meta name="author" content = "Zeng">
    
    
    <link rel="stylesheet" href="/css/style.css">
    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



  
    <link rel="stylesheet" href="/css/syntax.css">
  

    

    
      

    

		
    

    
      <link rel="canonical" href="https://zhighway777.github.io/2024/09/27/buddy_src_2/">
    

    <meta property="og:title" content="Buddy Compiler æºç è§£è¯»(2)" />
<meta property="og:description" content="A brief introduction to the overall architectyre of buddy Compiler and an analysis some of the buddy. (...)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhighway777.github.io/2024/09/27/buddy_src_2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-09-27T13:19:05+08:00" />
<meta property="article:modified_time" content="2024-09-27T13:19:05+08:00" />

<meta itemprop="name" content="Buddy Compiler æºç è§£è¯»(2)">
<meta itemprop="description" content="A brief introduction to the overall architectyre of buddy Compiler and an analysis some of the buddy. (...)"><meta itemprop="datePublished" content="2024-09-27T13:19:05+08:00" />
<meta itemprop="dateModified" content="2024-09-27T13:19:05+08:00" />
<meta itemprop="wordCount" content="1933">
<meta itemprop="keywords" content="MLIR,AI Compiler," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Buddy Compiler æºç è§£è¯»(2)"/>
<meta name="twitter:description" content="A brief introduction to the overall architectyre of buddy Compiler and an analysis some of the buddy. (...)"/>

	
<link rel="stylesheet" href="/css/style.css">


<script src="/js/visit-counter.js"></script>


<style>
   
  .visit-counter-info {
    font-size: 0.8em;
    color: #666;
    opacity: 0.7;
    text-align: center;
    margin-top: 10px;
  }
  
   
  .visit-stats-hidden {
    position: fixed;
    bottom: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 1000;
    display: none;
  }
  
   
  body.debug-mode .visit-stats-hidden {
    display: block;
  }
</style>


<div class="visit-stats-hidden" id="globalVisitStats">
  ç½‘ç«™è®¿é—®: <span id="globalVisitCount">0</span>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  
  function updateGlobalVisitDisplay() {
    if (window.VisitCounter) {
      const visitCount = window.VisitCounter.getWebsiteVisits();
      const globalCountElement = document.getElementById('globalVisitCount');
      if (globalCountElement) {
        globalCountElement.textContent = visitCount.toLocaleString();
      }
    }
  }
  
  
  document.addEventListener('websiteVisitUpdated', function(event) {
    updateGlobalVisitDisplay();
    
    
    console.log('ç½‘ç«™è®¿é—®ç»Ÿè®¡æ›´æ–°:', event.detail);
  });
  
  
  setTimeout(updateGlobalVisitDisplay, 200);
  
  
  let clickCount = 0;
  document.addEventListener('click', function() {
    clickCount++;
    if (clickCount === 3) {
      document.body.classList.toggle('debug-mode');
      console.log('è°ƒè¯•æ¨¡å¼å·²', document.body.classList.contains('debug-mode') ? 'å¼€å¯' : 'å…³é—­');
      clickCount = 0;
    }
    setTimeout(() => { clickCount = 0; }, 1000);
  });
});
</script>



  



 
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Zeng::blog
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Blog page">
              Blog
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="About me page">
              About me
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/album/" title="Album page">
              Album
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
    
    <a href="https://github.com/Zhighway777" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHubâ€”â€”Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Buddy Compiler æºç è§£è¯»(2)</h1>
      
      
      <p class="tracked">
        By <strong>Zeng</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2024-09-27T13:19:05+08:00">September 27, 2024</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id="bud-dialect">Bud Dialect</h1>
<p>æœ‰äº†ä¹‹å‰çš„ä¾‹å­ä½œä¸ºæ”¯æ’‘ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥ç›¸å…³çš„Dialect, åˆ†æBuddy Compileræ˜¯å¦‚ä½•è¿›è¡ŒLowering, Conversationç­‰æ“ä½œçš„ã€‚</p>
<h2 id="dialectçš„tablegen">Dialectçš„TableGen</h2>
<p>å…³äºDialectçš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨midendä¸­æ‰¾åˆ°ï¼Œè¿™ä¹Ÿç¬¦åˆå…¶åœ¨ç¼–è¯‘å™¨ä¸­çš„ä½ç½®ã€‚</p>
<p>/midend/include/Dialect/Bud ä¸‹æœ‰å››ä¸ªå…³äºBud Dialectçš„æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯BudDialect.h, BudDialect.td, BudOps.h, BudOps.tdã€‚</p>
<aside>
ğŸ’¡
<p>è¿™é‡Œ.hæ–‡ä»¶ä¸­incluceäº†ä¸€äº›.tdæ–‡ä»¶éœ€è¦çš„åº“ï¼Œ<strong>è®¸å¤šäººç¬¬ä¸€æ¬¡æ¥è§¦(.td)æ–‡ä»¶,è¿™æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
(.td)å…¨ç§°ä¸ºTableGenæ–‡ä»¶ï¼Œæ˜¯LLVMçš„ä¸€ä¸ªå·¥å…·ï¼ŒåŠŸèƒ½å°±æ˜¯è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼ˆtdæ–‡ä»¶ï¼‰ï¼Œè§£æè¿™ä¸ªæ–‡ä»¶ï¼Œè¾“å‡ºæˆä¸åŒçš„ç»“æœæ–‡ä»¶ã€‚</p>
<p>MLIRä½¿ç”¨æ­¤æ–‡ä»¶ä½œä¸ºä¸ºæ“ä½œè¡¨è¿°(ODS)ï¼Œå¯ä»¥ç†è§£ä¸ºTableGenè¯­è¨€ä¸­çš„DSLã€‚è¿™äº›ä»£ç æœ€ç»ˆä¼šè½¬æ¢ä¸ºC++ä»£ç </p>
<p>[1] <a href="https://llvm.org/docs/TableGen/#tablegen-overview"><strong>TableGen Overview</strong></a></p>
<p>[2] <a href="https://zhuanlan.zhihu.com/p/141265959"><strong>æœ‰å…³äºTableGençš„ç®€å•ä»‹ç»</strong></a></p>
</aside>
<p>åœ¨MLIRä¸­ï¼ŒTableGençš„æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="/img/buddy_dialect_0.png" alt="image.png"></p>
<p>ä»ä¸Šå¾€ä¸‹ä¾æ¬¡æ˜¯ï¼šOpåç§°ï¼ŒOpç‰¹å¾åˆ—è¡¨ï¼ŒOpçš„summary doc, Opçš„description doc, Opçš„å‚æ•°åˆ—è¡¨ï¼Œ Opçš„ç»“æœåŠå…¶ç±»å‹çº¦æŸã€‚</p>
<p>ä¸Šé¢æ ‡çº¢çš„é¡¹æ˜¯å®šä¹‰ä¸€ä¸ªOpçš„å¿…è¦ä¿¡æ¯</p>
<p>è¿™é‡Œï¼Œåœ¨BudOps.tdæ–‡ä»¶ä¸­ä¸»è¦å®šä¹‰äº†å››ç§æ“ä½œï¼š</p>
<p>Bud_TestConstantOp, Bud_TestPrintOp, Bud_TestEnumAttrOperation, Bud_TestArrayAttrOp</p>
<h2 id="dialect-lowering">Dialect Lowering</h2>
<p>æœ‰äº†ä¸Šè¿°çš„åŸºç¡€æ“ä½œï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸ºBud Dialectæ³¨å†Œä¸€ä¸ªLowering, è¿™ä¸ªå·²ç»åœ¨ <code>lib/Conversion/LowerBud/LowerBudPass.cpp</code> ä¸­å®ç°çš„LowerBudPass å¦‚ä¸‹æ‰€ç¤º</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">//ç±»å£°æ˜ï¼ŒBudTestConstantLoweringç±»ç»§æ‰¿è‡ªOpRewritePAttern
</span><span class="c1">//OpRewritePatternæ˜¯æ¨¡æ¿ç±»ï¼Œä¸“é—¨ç”¨äºå®šä¹‰é‡å†™MLIRçš„æ¨¡æ¿
</span><span class="c1">//&lt;xx&gt;å†…æ˜¯è¢«é‡å†™çš„æ“ä½œç±»å‹
</span><span class="c1"></span><span class="k">class</span> <span class="nc">BudTestConstantLowering</span> <span class="o">:</span> <span class="k">public</span> <span class="n">OpRewritePattern</span><span class="o">&lt;</span><span class="n">bud</span><span class="o">::</span><span class="n">TestConstantOp</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="c1">//usingå¯ä»¥ä»åŸºç±»OpRewritePatternä¸­ç»§æ‰¿æ„é€ å‡½æ•°ï¼Œè¿™é‡Œä½¿ç”¨åŸºç±»ä¸­çš„æ„é€ å‡½æ•°å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–
</span><span class="c1"></span>  <span class="k">using</span> <span class="n">OpRewritePattern</span><span class="o">&lt;</span><span class="n">bud</span><span class="o">::</span><span class="n">TestConstantOp</span><span class="o">&gt;::</span><span class="n">OpRewritePattern</span><span class="p">;</span>
	<span class="c1">//matchAndRewriteæ˜¯OpRewritePattern&lt;..&gt;ç±»ä¸­çš„ä¸€ä¸ªè™šå‡½æ•°ï¼Œå°†ä¼šè¢«è¿›è¡Œé‡å†™
</span><span class="c1"></span>  <span class="n">LogicalResult</span> <span class="nf">matchAndRewrite</span><span class="p">(</span><span class="n">bud</span><span class="o">::</span><span class="n">TestConstantOp</span> <span class="n">op</span><span class="p">,</span>
                                <span class="n">PatternRewriter</span> <span class="o">&amp;</span><span class="n">rewriter</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">getLoc</span><span class="p">();</span>
    <span class="c1">// Get type from the origin operation.
</span><span class="c1"></span>    <span class="n">Type</span> <span class="n">resultType</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">getResult</span><span class="p">().</span><span class="n">getType</span><span class="p">();</span>
    <span class="c1">// Create constant operation.
</span><span class="c1"></span>    <span class="n">Value</span> <span class="n">c0</span> <span class="o">=</span> <span class="n">rewriter</span><span class="p">.</span><span class="n">create</span><span class="o">&lt;</span><span class="n">mlir</span><span class="o">::</span><span class="n">arith</span><span class="o">::</span><span class="n">ConstantOp</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">loc</span><span class="p">,</span> <span class="n">resultType</span><span class="p">,</span> <span class="n">rewriter</span><span class="p">.</span><span class="n">getZeroAttr</span><span class="p">(</span><span class="n">resultType</span><span class="p">));</span>

    <span class="n">rewriter</span><span class="p">.</span><span class="n">replaceOp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">c0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">success</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div><p>å¦‚è¿‡ä½ æ˜¯ä¸€ä½C++æ–°æ‰‹ï¼Œä½ éœ€è¦è¡¥å……ç±»(class)ï¼Œæ„é€ å‡½æ•°(construct function)ï¼Œç±»çš„ç»§æ‰¿(derived class)ï¼Œæ´¾ç”Ÿç±»çš„æ„é€ å‡½æ•°ï¼Œè™šå‡½æ•°(virtual function)ç›¸å…³çŸ¥è¯†ç‚¹æ‰èƒ½çœ‹æ‡‚ä¸Šé¢çš„ä»£ç ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°è¯¥ç±»çš„ä½œç”¨æ˜¯åœ¨åŒ¹é…åˆ°bud::TestConstantOp åä¼šå°†å…¶é‡å†™ä¸ºmlir::arith::ConstantOp</p>
<p>å…¶æ‰§è¡Œçš„è¿‡ç¨‹åœ¨[Buddy æºç è§£è¯»(0)]ä¸­å¯ä»¥çœ‹åˆ°ã€‚</p>
<h3 id="é˜è¿°-tdæ–‡ä»¶å’Œloweringçš„å…³ç³»">é˜è¿° .tdæ–‡ä»¶å’ŒLoweringçš„å…³ç³»</h3>
<p><code>.td</code> æ–‡ä»¶ä¸­çš„å®šä¹‰æè¿°äº† <code>Bud_TestConstantOp</code> æ˜¯å¦‚ä½•åœ¨ MLIR ä¸­è¡¨ç¤ºçš„ï¼Œåœ¨MLIRçš„ç¼–è¯‘Pipelineä¸­ï¼Œä»–å¯èƒ½åœ¨å‰æœŸä½œä¸ºIRè¢«ä½¿ç”¨ï¼Œä½†æœ€ç»ˆéœ€è¦å°†ä»–è½¬åŒ–ä¸ºæŸä¸ªå·²ç»å®šä¹‰çš„<code>ä½çº§åˆ«æ“ä½œ</code> ã€‚è€Œ<code>BudTestConstantLowering</code> ç±»è´Ÿè´£åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå°†è¿™ä¸ªè‡ªå®šä¹‰çš„æ“ä½œè½¬æ¢ä¸ºæ ‡å‡†çš„ä½çº§æ“ä½œ <code>arith::ConstantOp</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">LowerBudPass</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PassWrapper</span><span class="o">&lt;</span><span class="n">LowerBudPass</span><span class="p">,</span> <span class="n">OperationPass</span><span class="o">&lt;</span><span class="n">ModuleOp</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">MLIR_DEFINE_EXPLICIT_INTERNAL_INLINE_TYPE_ID</span><span class="p">(</span><span class="n">LowerBudPass</span><span class="p">)</span>
  <span class="n">LowerBudPass</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">LowerBudPass</span><span class="p">(</span><span class="k">const</span> <span class="n">LowerBudPass</span> <span class="o">&amp;</span><span class="p">)</span> <span class="p">{}</span>
	<span class="c1">//ä¸¤ä¸ªè™šå‡½æ•°
</span><span class="c1"></span>	<span class="c1">//è¿”å›è¯¥ Pass çš„å‘½ä»¤è¡Œå‚æ•°åç§°ï¼Œåœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨æ—¶ï¼Œé€šè¿‡ --lower-bud æ¥è°ƒç”¨è¿™ä¸ª pass
</span><span class="c1"></span>	<span class="c1">//å‘½ä»¤è¡Œè°ƒç”¨
</span><span class="c1"></span>  <span class="n">StringRef</span> <span class="nf">getArgument</span><span class="p">()</span> <span class="k">const</span> <span class="k">final</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&#34;lower-bud&#34;</span><span class="p">;</span> <span class="p">}</span>
  <span class="c1">//getDescription() è¿”å›è¯¥ Pass çš„æè¿°ä¿¡æ¯ï¼Œç”¨äºæä¾›ç”¨æˆ·å¯è¯»çš„è¯´æ˜
</span><span class="c1"></span>  <span class="n">StringRef</span> <span class="nf">getDescription</span><span class="p">()</span> <span class="k">const</span> <span class="k">final</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&#34;Lower Bud Dialect.&#34;</span><span class="p">;</span> <span class="p">}</span>
   <span class="c1">//çº¯è™šå‡½æ•°ï¼Œåœ¨æ´¾ç”Ÿç±»ä¸­å¿…é¡»è¢«å®ç°ã€‚
</span><span class="c1"></span>   <span class="c1">//å‡½æ•°å°†åœ¨ ModuleOp ä¸Šæ‰§è¡Œ lower è¿‡ç¨‹ã€‚
</span><span class="c1"></span>   <span class="c1">//åœ¨è¿™é‡Œï¼ŒModuleOp å¯èƒ½åŒ…å«ä¸€ç³»åˆ—é«˜å±‚æ¬¡çš„ Bud æ–¹è¨€æ“ä½œï¼Œ
</span><span class="c1"></span>   <span class="c1">//runOnOperation() ä¼šå°†è¿™äº›æ“ä½œé€æ­¥è½¬æ¢ä¸ºåº•å±‚çš„ MLIR æ“ä½œï¼Œ
</span><span class="c1"></span>   <span class="c1">//å¦‚ FuncDialectã€MemRefDialectã€VectorDialect ç­‰æ“ä½œã€‚è¿™æ˜¯ pass çš„æ ¸å¿ƒé€»è¾‘ã€‚
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">runOnOperation</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
	<span class="c1">//ç¡®æŒ‡å‡ºäº†è¯¥ pass åœ¨è¿è¡Œæ—¶ä¾èµ–çš„æ–¹è¨€
</span><span class="c1"></span>	<span class="c1">//ä¾èµ–æ–¹è¨€æ³¨å†Œ
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">getDependentDialects</span><span class="p">(</span><span class="n">DialectRegistry</span> <span class="o">&amp;</span><span class="n">registry</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// clang-format off
</span><span class="c1"></span>    <span class="n">registry</span><span class="p">.</span><span class="n">insert</span><span class="o">&lt;</span>
        <span class="n">buddy</span><span class="o">::</span><span class="n">bud</span><span class="o">::</span><span class="n">BudDialect</span><span class="p">,</span>
        <span class="n">func</span><span class="o">::</span><span class="n">FuncDialect</span><span class="p">,</span>
        <span class="n">vector</span><span class="o">::</span><span class="n">VectorDialect</span><span class="p">,</span>
        <span class="n">memref</span><span class="o">::</span><span class="n">MemRefDialect</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="c1">// clang-format on
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// end anonymous namespace.
</span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">//è¿™é‡Œæ˜¯å¯¹ç»§æ‰¿ç±» LowerBudPassä¸­ runOnOperation()æ–¹æ³•çš„å…·ä½“å®ç°
</span><span class="c1"></span><span class="kt">void</span> <span class="n">LowerBudPass</span><span class="o">::</span><span class="n">runOnOperation</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">MLIRContext</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">getContext</span><span class="p">();</span>
  <span class="n">ModuleOp</span> <span class="n">module</span> <span class="o">=</span> <span class="n">getOperation</span><span class="p">();</span>
	<span class="c1">//è½¬æ¢ç›®æ ‡ï¼Œå®šä¹‰äº†é‚£äº›æ“ä½œæ˜¯åˆæ³•çš„
</span><span class="c1"></span>  <span class="n">ConversionTarget</span> <span class="nf">target</span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">);</span>
  <span class="n">target</span><span class="p">.</span><span class="n">addLegalDialect</span><span class="o">&lt;</span>
      <span class="n">arith</span><span class="o">::</span><span class="n">ArithmeticDialect</span><span class="p">,</span>
      <span class="n">func</span><span class="o">::</span><span class="n">FuncDialect</span><span class="p">,</span>
      <span class="n">vector</span><span class="o">::</span><span class="n">VectorDialect</span><span class="p">,</span>
      <span class="n">memref</span><span class="o">::</span><span class="n">MemRefDialect</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">target</span><span class="p">.</span><span class="n">addLegalOp</span><span class="o">&lt;</span><span class="n">ModuleOp</span><span class="p">,</span> <span class="n">func</span><span class="o">::</span><span class="n">FuncOp</span><span class="p">,</span> <span class="n">func</span><span class="o">::</span><span class="n">ReturnOp</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">RewritePatternSet</span> <span class="nf">patterns</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
  <span class="c1">//è°ƒç”¨ä¸‹é¢çš„å‡½æ•°æ‰‹æœºä¸Budç›¸å…³çš„Loweringè§„åˆ™ï¼Œå¦‚ä¹‹å‰çš„BudTestConstantLowering å°±æ˜¯é‡å†™çš„æ¨¡å¼ä¹‹ä¸€
</span><span class="c1"></span>  <span class="n">populateLowerBudConversionPatterns</span><span class="p">(</span><span class="n">patterns</span><span class="p">);</span>
	<span class="c1">//æ‰§è¡Œé‡å†™æ“ä½œ
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">(</span><span class="n">applyPartialConversion</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">patterns</span><span class="p">))))</span>
    <span class="n">signalPassFailure</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div><p>æ€»ç»“ä¸€ä¸‹ LowerBudPass.cppçš„ä½œç”¨ï¼š</p>
<ul>
<li><strong>è½¬æ¢è‡ªå®šä¹‰æ–¹è¨€</strong>ï¼šå®ƒå°†é«˜å±‚æ¬¡çš„ Bud æ–¹è¨€æ“ä½œé€æ­¥é™ä½ä¸ºä½å±‚æ¬¡çš„æ ‡å‡† MLIR æ“ä½œï¼Œä½¿å¾—è¿™äº›æ“ä½œå¯ä»¥æ›´æ¥è¿‘ç¡¬ä»¶æ‰§è¡Œï¼Œæˆ–è€…ä¸æ ‡å‡†ç¼–è¯‘åŸºç¡€è®¾æ–½ï¼ˆå¦‚ LLVM IRï¼‰å…¼å®¹ã€‚</li>
<li><strong>ä¼˜åŒ–æµç¨‹çš„ä¸€éƒ¨åˆ†</strong>ï¼šMLIR Pipeline ä¸­é€šå¸¸åŒ…å«å¤šä¸ª passï¼Œ<code>LowerBudPass</code> æ˜¯å…¶ä¸­çš„ <strong>Lowering pass</strong>ï¼Œç”¨äºåœ¨ç¼–è¯‘çš„æ—©æœŸé˜¶æ®µå°†ç”¨æˆ·è‡ªå®šä¹‰çš„é«˜çº§è¯­è¨€æˆ–é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDSLï¼‰çš„æ“ä½œè½¬æ¢ä¸ºä¸­é—´è¡¨ç¤ºï¼Œå‡†å¤‡è¿›å…¥åç»­ä¼˜åŒ–é˜¶æ®µã€‚</li>
</ul>
<p>é€šè¿‡ <code>LowerBudPass</code>ï¼Œæ•´ä¸ª MLIR ç¼–è¯‘æµç¨‹å¯ä»¥ä»é«˜å±‚æ¬¡è‡ªå®šä¹‰è¯­è¨€å±‚é¢é€æ¸è½¬åŒ–ä¸ºä½å±‚æ¬¡ã€å¯æ‰§è¡Œçš„ç¡¬ä»¶å‹å¥½ä»£ç </p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/mlir/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">MLIR</a>
   </li>
  
   <li class="list di">
     <a href="/tags/ai-compiler/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AI Compiler</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Table of contents</p>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#dialectçš„tablegen">Dialectçš„TableGen</a></li>
    <li><a href="#dialect-lowering">Dialect Lowering</a>
      <ul>
        <li><a href="#é˜è¿°-tdæ–‡ä»¶å’Œloweringçš„å…³ç³»">é˜è¿° .tdæ–‡ä»¶å’ŒLoweringçš„å…³ç³»</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/2024/09/06/buddy_src_0/">Buddy Compiler æºç è§£è¯»(0)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2024/09/06/buddy_src_1/">Buddy Compiler æºç è§£è¯»(1)</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://zhighway777.github.io/" >
    &copy;  Zeng::blog 2025 
  </a>
    <div>
<div class="ananke-socials">
  
    
    <a href="https://github.com/Zhighway777" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHubâ€”â€”Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
